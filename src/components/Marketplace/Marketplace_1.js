import React, { useState, useEffect } from "react";
import { useLocation, Link, useNavigate } from "react-router-dom";
import { Container, Row, Col, Card, Button, Badge, Form, Modal } from "react-bootstrap";
import './Marketplace_2.css';
import { io } from "socket.io-client";
import AddProducts from "./AddProducts";
import axios from "../../api";

const socket = io("http://localhost:5000", { transports: ["websocket"] });

// ==================== Role Labels ====================
const roleLabels = {
  Farmer: "ржХрзГрж╖ржХ",
  Expert: "ржХрзГрж╖рж┐ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ",
  Coordinator: "рж╕рзНржерж╛ржирзАрзЯ рж╕ржоржирзНржмрзЯржХрж╛рж░рзА",
  Entrepreneur: "рж╕рзНржЯрж╛рж░рзНржЯржЖржк ржЙржжрзНржпрзЛржХрзНрждрж╛",
  Supplier: "рж╕рж░ржмрж░рж╛рж╣ржХрж╛рж░рзА",
  Investor: "ржмрж┐ржирж┐рзЯрзЛржЧржХрж╛рж░рзА",
};

// ==================== SupplierDashboard Component ====================
const SupplierDashboard = () => {
  const storedUser = JSON.parse(localStorage.getItem("user"));
  const [user] = useState(storedUser || {});
  const [showAdd, setShowAdd] = useState(false);
  const [productsList, setProductsList] = useState([]);
  const [orders, setOrders] = useState([]);
  const location = useLocation();
  const navigate = useNavigate();

  const handleAddProductClick = () => setShowAdd(true);
  const handleClose = () => setShowAdd(false);

  const handleLogout = () => {
    localStorage.removeItem("user");
    localStorage.removeItem("token");
    navigate('/login', { replace: true });
  };

  const isMarketActive = location.pathname === '/market';

  const handleProductAdded = (newProduct) => {
    if (newProduct) {
      setProductsList(prev => Array.isArray(prev) ? [newProduct, ...prev] : [newProduct]);
      socket.emit("new-product", newProduct);
    }
  };

  // Fetch supplier's products
  useEffect(() => {
    const fetchSupplierProducts = async () => {
      try {
        const token = localStorage.getItem("token");
        const response = await fetch("http://localhost:5000/api/products", {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });
        const data = await response.json();
        if (data.success) {
          setProductsList(data.products || []);
        }
      } catch (error) {
        console.error("Error fetching products:", error);
      }
    };

    if (user?.role?.toLowerCase() === "supplier") {
      fetchSupplierProducts();
    }
  }, [user]);

  return (
    <>
      {/* Navbar */}
      <nav className="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div className="container">
          <Link className="navbar-brand fw-bold text-success" to="/home">
            BD <span className="text-dark">ржХрзГрж╖рж┐ ржжрж┐ржмрж╛ржирж┐рж╢рж┐</span>
          </Link>
          <button className="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#MarketplaceNavbar">
            <span className="navbar-toggler-icon"></span>
          </button>
          <div className="collapse navbar-collapse justify-content-between" id="MarketplaceNavbar">
            <ul className="navbar-nav mx-auto mb-2 mb-lg-0">
              <li className="nav-item"><Link className="nav-link" to="/home">рж╣рзЛржо</Link></li>
              <li className="nav-item"><Link className="nav-link" to="/dashboard">ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</Link></li>
              <li className="nav-item"><Link className="nav-link" to="/community">ржХржорж┐ржЙржирж┐ржЯрж┐</Link></li>
              <li className="nav-item"><Link className="nav-link" to="/resources">рж░рж┐рж╕рзЛрж░рзНрж╕</Link></li>
              <li className="nav-item">
                <Link 
                  className={`nav-link ${isMarketActive ? 'active text-success fw-bold' : ''}`} 
                  to="/market" 
                  state={{ supplierView: true }}
                >
                  ржмрж╛ржЬрж╛рж░
                </Link>
              </li>
            </ul>
            <div className="d-flex">
              <button className="btn btn-success me-2">
                {roleLabels[user?.role] || "ржЗржЙржЬрж╛рж░"}
              </button>
              <button className="btn btn-outline-danger" onClick={handleLogout}>
                рж▓ржЧржЖржЙржЯ
              </button>
            </div>
          </div>
        </div>
      </nav>

      <div className="marketplace-section">
        <Container>
          <div className="marketplace-header text-center mb-5">
            <h2 className="fw-bold">рж╕рж░ржмрж░рж╛рж╣ржХрж╛рж░рзА ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</h2>
            <p className="text-muted">Supplier Dashboard</p>
          </div>

          <Row className="g-4">
            {/* ржкржгрзНржп ржмрж┐ржХрзНрж░рзЯ ржХрж░рзБржи */}
            <Col md={6}>
              <Card className="supplier-card h-100">
                <div className="text-center">
                  <div className="supplier-icon">ЁЯУж</div>
                  <h5>ржкржгрзНржп ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛</h5>
                  <p>ржЖржкржирж╛рж░ рж╕ржХрж▓ рждрж╛рж▓рж┐ржХрж╛ржнрзБржХрзНржд ржкржгрзНржп ржжрзЗржЦрзБржи, ржорзНржпрж╛ржирзЗржЬ ржХрж░рзБржи ржПржмржВ ржирждрзБржи ржкржгрзНржп ржпрзЛржЧ ржХрж░рзБржиред</p>
                </div>
                <div className="d-flex flex-column gap-2 mt-3">
                  <Button variant="success" onClick={handleAddProductClick}>
                    тЮХ ржирждрзБржи ржкржгрзНржп ржпрзЛржЧ ржХрж░рзБржи
                  </Button>
                  <AddProducts show={showAdd} handleClose={handleClose} onProductAdded={handleProductAdded} />
                  <Button variant="outline-primary">
                    ЁЯУЛ ржЖржорж╛рж░ ржкржгрзНржп ({productsList.length})
                  </Button>
                </div>
                {productsList.length > 0 && (
                  <div className="mt-3">
                    <small className="text-muted">рж╕рж░рзНржмрж╢рзЗрж╖ ржпрзЛржЧржХрзГржд: {productsList[0]?.title}</small>
                  </div>
                )}
              </Card>
            </Col>

            {/* ржЕрж░рзНржбрж╛рж░рж╕ржорзВрж╣ */}
            <Col md={6}>
              <Card className="supplier-card h-100">
                <div className="text-center">
                  <div className="supplier-icon">ЁЯЫТ</div>
                  <h5>ржЕрж░рзНржбрж╛рж░ ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛</h5>
                  <p>ржЖржкржирж╛рж░ рж╕ржХрж▓ ржЕрж░рзНржбрж╛рж░ ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рзБржи ржПржмржВ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржЖржкржбрзЗржЯ ржХрж░рзБржиред</p>
                </div>
                <div className="d-flex flex-column gap-2 mt-3">
                  <Button variant="success">
                    ЁЯУж ржирждрзБржи ржЕрж░рзНржбрж╛рж░ ржжрзЗржЦрзБржи ({orders.length})
                  </Button>
                  <Button variant="outline-primary">
                    ЁЯУК ржЕрж░рзНржбрж╛рж░ рж╣рж┐рж╕рзНржЯрзНрж░рж┐
                  </Button>
                </div>
                {orders.length === 0 && (
                  <div className="mt-3">
                    <small className="text-muted">ржХрзЛржи ржирждрзБржи ржЕрж░рзНржбрж╛рж░ ржирзЗржЗ</small>
                  </div>
                )}
              </Card>
            </Col>
          </Row>

          {/* Recent Products Preview */}
          {productsList.length > 0 && (
            <Row className="mt-5">
              <Col>
                <Card>
                  <Card.Header>
                    <h5 className="mb-0">ржЖржкржирж╛рж░ рж╕рж░рзНржмрж╢рзЗрж╖ ржкржгрзНржпрж╕ржорзВрж╣</h5>
                  </Card.Header>
                  <Card.Body>
                    <Row className="g-3">
                      {productsList.slice(0, 3).map((product, index) => (
                        <Col md={4} key={index}>
                          <Card className="product-preview-card">
                            <Card.Body>
                              <h6>{product.title}</h6>
                              <p className="text-success mb-1">{product.price} ржЯрж╛ржХрж╛</p>
                              <small className="text-muted">ржкрж░рж┐ржорж╛ржг: {product.quantity}</small>
                            </Card.Body>
                          </Card>
                        </Col>
                      ))}
                    </Row>
                  </Card.Body>
                </Card>
              </Col>
            </Row>
          )}
        </Container>
      </div>
    </>
  );
};

// ==================== Marketplace Component ====================
const Marketplace = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const [supplierView, setSupplierView] = useState(false);
  const [productsState, setProducts] = useState([]);
  const [activeFilter, setActiveFilter] = useState("all");
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [visibleProducts, setVisibleProducts] = useState(9);

  const handleClose = () => setSelectedProduct(null);
  const handleShowMore = () => setVisibleProducts(prev => prev + 6);

  const handleLogout = () => {
    localStorage.removeItem("user");
    localStorage.removeItem("token");
    navigate('/login');
  };

  const isMarketActive = location.pathname === '/market';

  // Fetch products
  useEffect(() => {
    const fetchProducts = async () => {
      try {
        const res = await axios.get("/products");
        setProducts(Array.isArray(res.data.products) ? res.data.products : []);
      } catch (err) {
        console.error(err);
      }
    };
    fetchProducts();
  }, []);

  // Socket.io for real-time updates
  useEffect(() => {
    socket.on("new-product", (product) => {
      if (product) {
        setProducts(prev => Array.isArray(prev) ? [product, ...prev] : [product]);
      }
    });
    return () => socket.off("new-product");
  }, []);

  // Supplier view check
  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("user"));
    if (location.state?.supplierView) {
      setSupplierView(true);
    } else if (user?.role?.toLowerCase() === "supplier") {
      setSupplierView(true);
    } else {
      setSupplierView(false);
    }
  }, [location.state]);

  // Filter products
  const filteredProducts = activeFilter === "all" 
    ? productsState 
    : productsState.filter(product => product.category === activeFilter);

  // Category counts
  const categoryCounts = {
    'all': productsState.length,
    'ржмрзАржЬ ржУ ржЪрж╛рж░рж╛': productsState.filter(p => p.category === 'ржмрзАржЬ ржУ ржЪрж╛рж░рж╛').length,
    'ржпржирзНрждрзНрж░ржкрж╛рждрж┐': productsState.filter(p => p.category === 'ржпржирзНрждрзНрж░ржкрж╛рждрж┐').length,
    'ржЦрж╛ржжрзНржп ржУ рж╕рж╛рж░': productsState.filter(p => p.category === 'ржЦрж╛ржжрзНржп ржУ рж╕рж╛рж░').length,
    'ржФрж╖ржз ржУ ржнрзНржпрж╛ржХрж╕рж┐ржи': productsState.filter(p => p.category === 'ржФрж╖ржз ржУ ржнрзНржпрж╛ржХрж╕рж┐ржи').length,
  };

  const categories = [
    { icon: "ЁЯМ╛", title: "ржмрзАржЬ ржУ ржЪрж╛рж░рж╛", value: "ржмрзАржЬ ржУ ржЪрж╛рж░рж╛" },
    { icon: "ЁЯЪЬ", title: "ржпржирзНрждрзНрж░ржкрж╛рждрж┐", value: "ржпржирзНрждрзНрж░ржкрж╛рждрж┐" },
    { icon: "ЁЯРД", title: "ржЦрж╛ржжрзНржп ржУ рж╕рж╛рж░", value: "ржЦрж╛ржжрзНржп ржУ рж╕рж╛рж░" },
    { icon: "ЁЯТЙ", title: "ржФрж╖ржз ржУ ржнрзНржпрж╛ржХрж╕рж┐ржи", value: "ржФрж╖ржз ржУ ржнрзНржпрж╛ржХрж╕рж┐ржи" },
  ];

  if (supplierView) return <SupplierDashboard />;

  const storedUser = JSON.parse(localStorage.getItem("user"));

  return (
    <>
      {/* Navbar */}
      <nav className="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div className="container">
          <Link className="navbar-brand fw-bold text-success" to="/home">
            BD <span className="text-dark">ржХрзГрж╖рж┐ ржжрж┐ржмрж╛ржирж┐рж╢рж┐</span>
          </Link>
          <button className="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#MarketplaceNavbar">
            <span className="navbar-toggler-icon"></span>
          </button>
          <div className="collapse navbar-collapse justify-content-between" id="MarketplaceNavbar">
            <ul className="navbar-nav mx-auto mb-2 mb-lg-0">
              <li className="nav-item"><Link className="nav-link" to="/home">рж╣рзЛржо</Link></li>
              <li className="nav-item"><Link className="nav-link" to="/dashboard">ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</Link></li>
              <li className="nav-item"><Link className="nav-link" to="/community">ржХржорж┐ржЙржирж┐ржЯрж┐</Link></li>
              <li className="nav-item"><Link className="nav-link" to="/resources">рж░рж┐рж╕рзЛрж░рзНрж╕</Link></li>
              <li className="nav-item">
                <Link 
                  className={`nav-link ${isMarketActive ? 'active text-success fw-bold' : ''}`} 
                  to="/market"
                >
                  ржмрж╛ржЬрж╛рж░
                </Link>
              </li>
            </ul>
            <div className="d-flex">
              <button className="btn btn-success me-2">
                {roleLabels[storedUser?.role] || "ржЗржЙржЬрж╛рж░"}
              </button>
              <button className="btn btn-outline-danger" onClick={handleLogout}>
                рж▓ржЧржЖржЙржЯ
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Marketplace Section */}
      <div className="marketplace-section">
        <Container>
          <div className="marketplace-header text-center mb-5">
            <h2 className="fw-bold">ржХрзГрж╖рж┐ ржжрж┐ржмрж╛ржирж┐рж╢рж┐ ржорж╛рж░рзНржХрзЗржЯржкрзНрж▓рзЗрж╕</h2>
            <p className="text-muted">Krishi Dibanishi Marketplace</p>
            <p className="text-muted fs-6 mx-auto" style={{ maxWidth: "600px" }}>
              ржХрзГрж╖рж┐, ржорзОрж╕рзНржп ржУ ржкрзНрж░рж╛ржгрж┐рж╕ржорзНржкржжрзЗрж░ ржЬржирзНржп ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ рж╕ржХрж▓ ржкржгрзНржп ржПржХ ржЬрж╛ржпрж╝ржЧрж╛ржпрж╝ред ржмрж┐рж╢рзНржмрж╕рзНржд рж╕рж░ржмрж░рж╛рж╣ржХрж╛рж░рзА ржУ рж╕рж╛рж╢рзНрж░ржпрж╝рзА ржорзВрж▓рзНржпред
            </p>
          </div>

          {/* Category Filters */}
          <Row className="mb-4 justify-content-center">
            <Col md={10}>
              <div className="d-flex flex-wrap gap-2 justify-content-center">
                <Button 
                  variant={activeFilter === 'all' ? 'success' : 'outline-success'} 
                  onClick={() => setActiveFilter('all')}
                  className="filter-btn"
                >
                  рж╕ржм ржкржгрзНржп ({categoryCounts.all})
                </Button>
                {categories.map((category, index) => (
                  <Button 
                    key={index}
                    variant={activeFilter === category.value ? 'success' : 'outline-success'} 
                    onClick={() => setActiveFilter(category.value)}
                    className="filter-btn"
                  >
                    {category.icon} {category.title} ({categoryCounts[category.value]})
                  </Button>
                ))}
              </div>
            </Col>
          </Row>

          {/* Category Overview */}
          <Row className="g-4 text-center mb-5">
            {categories.map(({ icon, title, value }, idx) => (
              <Col md={3} key={idx}>
                <Card className="category-card">
                  <div className="category-icon">{icon}</div>
                  <h5>{title}</h5>
                  <Badge bg="light" text="dark" className="count-badge">
                    {categoryCounts[value]} ржкржгрзНржп
                  </Badge>
                </Card>
              </Col>
            ))}
          </Row>

          {/* Products Grid */}
          <div className="products-section">
            <h4 className="mb-4 fw-bold text-center">
              {activeFilter === 'all' ? 'рж╕ржХрж▓ ржкржгрзНржп' : `${activeFilter} - ржкржгрзНржпрж╕ржорзВрж╣`}
            </h4>
            
            {filteredProducts.length === 0 ? (
              <div className="text-center py-5">
                <div className="empty-state">
                  <div style={{ fontSize: '4rem' }}>ЁЯЫТ</div>
                  <h5 className="mt-3">ржХрзЛржи ржкржгрзНржп ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐</h5>
                  <p className="text-muted">ржПржЗ ржмрж┐ржнрж╛ржЧрзЗ ржПржЦржирзЛ ржХрзЛржи ржкржгрзНржп ржпрзЛржЧ ржХрж░рж╛ рж╣ржпрж╝ржирж┐</p>
                </div>
              </div>
            ) : (
              <>
                <Row className="g-4">
                  {filteredProducts.slice(0, visibleProducts).map((product, idx) => (
                    <Col md={4} key={idx}>
                      <Card 
                        className="product-card h-100" 
                        onClick={() => setSelectedProduct(product)}
                      >
                        {/* Product Image */}
                        <div className="product-image-container">
                          {product.image ? (
                            <img 
                              src={`http://localhost:5000/uploads/${product.image}`} 
                              alt={product.title}
                              className="product-image"
                            />
                          ) : (
                            <div className="product-placeholder">
                              ЁЯЫТ
                            </div>
                          )}
                        </div>
                        
                        <Card.Body className="d-flex flex-column">
                          {/* Product Category */}
                          <Badge bg="success" className="align-self-start mb-2">
                            {product.category}
                          </Badge>
                          
                          {/* Product Title */}
                          <h6 className="product-title">{product.title}</h6>
                          
                          {/* Product Description */}
                          <p className="product-description">
                            {product.description || 'ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржмрж┐ржмрж░ржг ржирзЗржЗ'}
                          </p>
                          
                          {/* Price and Quantity */}
                          <div className="mt-auto">
                            <div className="d-flex justify-content-between align-items-center mb-2">
                              <h5 className="product-price text-success mb-0">
                                {product.price} ржЯрж╛ржХрж╛
                              </h5>
                              <Badge bg="outline-secondary" className="quantity-badge">
                                {product.quantity} ржЗржЙржирж┐ржЯ
                              </Badge>
                            </div>
                            
                            {/* Supplier Info */}
                            {product.supplierId && (
                              <div className="supplier-info">
                                <small className="text-muted">
                                  рж╕рж░ржмрж░рж╛рж╣ржХрж╛рж░рзА: {product.supplierId.name}
                                </small>
                              </div>
                            )}
                            
                            <Button variant="outline-success" size="sm" className="w-100">
                              ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржжрзЗржЦрзБржи
                            </Button>
                          </div>
                        </Card.Body>
                      </Card>
                    </Col>
                  ))}
                </Row>

                {/* Load More Button */}
                {visibleProducts < filteredProducts.length && (
                  <div className="text-center mt-4">
                    <Button variant="success" onClick={handleShowMore}>
                      ржЖрж░ржУ ржкржгрзНржп ржжрзЗржЦрзБржи ({filteredProducts.length - visibleProducts}ржЯрж┐ ржмрж╛ржХрж┐)
                    </Button>
                  </div>
                )}
              </>
            )}
          </div>
        </Container>
      </div>

      {/* Product Detail Modal */}
      {selectedProduct && (
        <Modal show={true} onHide={handleClose} centered size="lg">
          <Modal.Header closeButton>
            <Modal.Title>{selectedProduct.title}</Modal.Title>
          </Modal.Header>
          <Modal.Body>
            <Row>
              <Col md={6}>
                {selectedProduct.image ? (
                  <img 
                    src={`http://localhost:5000/uploads/${selectedProduct.image}`} 
                    alt={selectedProduct.title}
                    className="img-fluid rounded"
                    style={{ width: '100%', maxHeight: '300px', objectFit: 'cover' }}
                  />
                ) : (
                  <div className="text-center py-4 bg-light rounded">
                    <div style={{ fontSize: '4rem' }}>ЁЯЫТ</div>
                    <p className="text-muted">ржЫржмрж┐ ржирзЗржЗ</p>
                  </div>
                )}
              </Col>
              <Col md={6}>
                <Badge bg="success" className="mb-3">{selectedProduct.category}</Badge>
                <h4 className="mb-3">{selectedProduct.title}</h4>
                
                <div className="product-details">
                  <p><strong>ржорзВрж▓рзНржп:</strong> <span className="text-success fs-5">{selectedProduct.price} ржЯрж╛ржХрж╛</span></p>
                  <p><strong>ржкрж░рж┐ржорж╛ржг:</strong> {selectedProduct.quantity} ржЗржЙржирж┐ржЯ</p>
                  <p><strong>ржмрж┐ржмрж░ржг:</strong> {selectedProduct.description || "ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд рждржерзНржп ржирзЗржЗред"}</p>
                </div>
                
                {/* Supplier Information */}
                {selectedProduct.supplierId && (
                  <>
                    <hr />
                    <h6>рж╕рж░ржмрж░рж╛рж╣ржХрж╛рж░рзА рждржерзНржп</h6>
                    <div className="supplier-details">
                      <p><strong>ржирж╛ржо:</strong> {selectedProduct.supplierId.name}</p>
                      <p><strong>ржЗржорзЗржЗрж▓:</strong> {selectedProduct.supplierId.email}</p>
                      <p><strong>ржлрзЛржи:</strong> {selectedProduct.supplierId.mobile || 'ржирзЗржЗ'}</p>
                      <p><strong>ржЕржмрж╕рзНржерж╛ржи:</strong> {selectedProduct.supplierId.district || 'ржирзЗржЗ'}</p>
                    </div>
                  </>
                )}
              </Col>
            </Row>
          </Modal.Body>
          <Modal.Footer className="d-flex justify-content-between">
            <Button variant="secondary" onClick={handleClose}>
              ржмржирзНржз ржХрж░рзБржи
            </Button>
            <Button variant="success" size="lg">
              ЁЯЫТ ржЕрж░рзНржбрж╛рж░ ржХрж░рзБржи
            </Button>
          </Modal.Footer>
        </Modal>
      )}
    </>
  );
};

export default Marketplace;